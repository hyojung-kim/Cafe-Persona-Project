<html layout:decorate="~{layout}">
<div layout:fragment="content">
    <link rel="stylesheet" th:href="@{/css/cafe_detail_review.css}">
    <link rel="stylesheet" th:href="@{/css/cafe_detail_con1.css}">

    <head>
        <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet">
    </head>

    <!-- ì¹´í˜ëª… + ì˜ì—…ìƒíƒœ -->
    <main class="container-1">

        <!-- ===== í—¤ë”: ì´ë¯¸ì§€ + ì •ë³´ ì¹´ë“œ ===== -->
        <section class="hero" aria-labelledby="cafeTitle">
            <!-- ì´ë¯¸ì§€ -->

            <div class="hero__imgwrap">
                <!-- ë¦¬ìŠ¤íŠ¸ê°€ nullì´ê±°ë‚˜ ë¹„ì—ˆì„ ë•Œ -->
                <img th:if="${#lists.isEmpty(images)}"
                     th:src="@{/images/DBimg.PNG}"
                     class="hero__img"
                     alt="ê¸°ë³¸ ëŒ€í‘œ ì´ë¯¸ì§€">

                <!-- ë¦¬ìŠ¤íŠ¸ì— ê°’ì´ ìˆì„ ë•Œ (ëŒ€í‘œ 1ì¥ë§Œ) -->
                <img th:if="${!#lists.isEmpty(images)}"
                     th:src="${images.get(0).imgUrl}"
                     class="hero__img"
                     alt="ì¹´í˜ ëŒ€í‘œ ì´ë¯¸ì§€">
            </div>


            <!-- ì •ë³´ ì¹´ë“œ -->
            <article class="card">
                <div>
                      <span class="title" id="cafeTitle" th:text="${cafe.name}"></span>
                      <span th:if="${openNow != null}"
                          class=""
                          th:classappend="${openNow} ? 'status open' : 'status closed'"
                          th:text="${openNow} ? '[ì˜ì—…ì¤‘]' : '[ì˜ì—… ë§ˆê°]'">ì˜ì—…ì¤‘</span>
                      <span th:if="${openNow == null}" class="muted">ì˜ì—…ì‹œê°„ ë¯¸ë“±ë¡</span>
                </div>
                <!-- ì •ë§ ë¹ˆì¹¸ìœ¼ë¡œ ë‘ê³  ì‹¶ìœ¼ë©´ ì•„ë˜ ì¤„ì„ ì‚­ì œí•˜ì„¸ìš” -->


                <div class="stats">
                    <span class="stat" th:text="|â­ ${#numbers.formatDecimal(avgRating, 1, 1)}"|>â˜… 4.5</span>
                    <span class="stat" th:text="|ë¦¬ë·° ${reviewCount}|">ë¦¬ë·° 0</span>
                    <span class="stat" th:text="|ğŸ‘ ì¡°íšŒìˆ˜ ${cafe.hitCount}"|>ì¡°íšŒ 0</span>
                    <div id="likeBox"
                         th:data-cafe-id="${cafe.id}"
                         th:data-liked="${liked}">
                        <button id="likeBtn" type="button" aria-label="ì¢‹ì•„ìš” í† ê¸€">
                            <span class="label-liked" th:if="${liked}">
                                <i class="fa-solid fa-bookmark" id="activeBookmark"></i>
                            </span>
                            <span class="label-unliked" th:if="${!liked}">
                                <i class="fa-regular fa-bookmark" id="disableBookmarkIcon"></i>
                            </span>
                        </button>
                        <span>
                            ë¶ë§ˆí¬ ì €ì¥ : <b id="likeCount" th:text="${likeCount}">0</b>
                        </span>
                    </div>
                </div>
                <div class="info-grid__row">
                    <div class="title-2">ì£¼ì†Œ</div>
                    <span class="info-grid__value">
                        <span class="link"
                              th:if="${cafe.streetAdr != null}"
                              th:text="|(${cafe.zipCode}) ${cafe.streetAdr} ${cafe.detailAdr}|"></span>

                        <!-- ìƒˆ ì£¼ì†Œê°€ ì—†ìœ¼ë©´ ê¸°ì¡´ address ì¶œë ¥ -->
                        <span class="link"
                              th:unless="${cafe.streetAdr != null}"
                              th:text="${cafe.address1}"></span>
                    </span>
                </div>
                <div class="chips">
                    <div class="title-2" id="">í˜„ì¬ ì¹´í˜ì˜ í‚¤ì›Œë“œ</div>
                    <span class="chip-kw" th:each="k : ${detailKeyword}" th:text="${k.name}">í•©ë¦¬ì ì¸</span>
                </div>
                <span th:if="${#lists.isEmpty(detailKeyword)}" class="chip--empty">
                    ë“±ë¡ëœ í‚¤ì›Œë“œê°€ ì—†ìŠµë‹ˆë‹¤.
                </span>
            </article>
        </section>

        <!-- ===== ì¹´í˜ ì†Œê°œ ===== -->
        <section class="store" aria-labelledby="storeTitle">
            <!-- ì œëª© -->
            <header class="store__header">
                <h2 id="storeTitle" class="store__title">ì¹´í˜ ì†Œê°œ</h2>
            </header>


            <div class="section-aside">
                <!-- ì •ë³´ ê·¸ë¦¬ë“œ -->
                <section class="store__info" aria-label="ê¸°ë³¸ ì •ë³´">
                    <!-- ì†Œê°œ ë¬¸ë‹¨ -->
                    <div class="store__intro">
                        <p class="intro" th:if="${#strings.isEmpty(cafe.intro)}">ë“±ë¡ëœ ì†Œê°œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <p class="intro" th:unless="${#strings.isEmpty(cafe.intro)}" th:text="${cafe.intro}"></p>
                    </div>
                    <ul class="info-grid">
                        <li class="info-grid__row">
                            <span class="info-grid__label">ì˜ì—…ì‹œê°„</span>
                            <span class="info-grid__value">
                            <!-- ìƒíƒœ ë°°ì§€ + ì‹œê°„ -->
                            <span th:if="${openNow != null}"
                                  class=""
                                  th:classappend="${openNow} ? 'status open' : 'status closed'"
                                  th:text="${openNow} ? '[ì˜ì—…ì¤‘]' : '[ì˜ì—… ë§ˆê°]'">ì˜ì—…ì¤‘</span>
                            <span th:if="${cafe.openTime != null and cafe.closeTime != null}"
                                  th:text="|${#temporals.format(cafe.openTime,'HH:mm')} ~ ${#temporals.format(cafe.closeTime,'HH:mm')}|">
                                09:00 ~ 22:00
                            </span>
                        </span>
                        </li>

                        <li class="info-grid__row">
                            <span class="info-grid__label">ì „í™”ë²ˆí˜¸</span>
                            <span class="info-grid__value">
                            <span th:if="${cafe.phoneNum}" th:text="${cafe.phoneNum}"></span>
                            <span th:unless="${cafe.phoneNum}" class="muted">ì—†ìŒ</span>
                        </span>
                        </li>

                        <li class="info-grid__row">
                            <span class="info-grid__label">í¸ì˜ì‹œì„¤</span>
                            <span class="info-grid__value">
                            <span class="chip-kw">
                            <strong>ì£¼ì°¨ </strong>
                            <span th:text="${cafe.parkingYn} ? 'ê°€ëŠ¥' : 'ë¶ˆê°€'">ê°€ëŠ¥</span>
                            </span>
                        </span>
                        </li>

                        <li class="info-grid__row">
                            <span class="info-grid__label">ì›¹ì‚¬ì´íŠ¸</span>
                            <span class="info-grid__value">
                            <a th:if="${cafe.siteUrl}" th:href="${cafe.siteUrl}" target="_blank" rel="noopener">ë°”ë¡œê°€ê¸°</a>
                            <span th:unless="${cafe.siteUrl}" class="muted">ì—†ìŒ</span>
                        </span>
                        </li>
                    </ul>
                </section>

                <aside class="menu-section" role="region" aria-labelledby="menuTitle">
                    <h3 id="menuTitle" class="menu-title">ë©”ë‰´ ëª©ë¡</h3>

                    <ul class="menu-list">
                        <li class="menu-item" th:each="m : ${menus}">
                            <span class="menu-name" th:text="${m.name}">ë©”ë‰´ëª…</span>

                            <!-- ê°€ê²© ìˆìœ¼ë©´ -->
                            <span class="menu-price"
                                  th:if="${m.price != null}"
                                  th:text="${#numbers.formatInteger(m.price, 0, 'COMMA')} + ' ì›'">5,800 ì›</span>

                            <!-- ê°€ê²© ì—†ìœ¼ë©´ -->
                            <span class="menu-price is-empty" th:unless="${m.price != null}">ë©”ë‰´ ì—†ìŒ</span>
                        </li>
                    </ul>
                </aside>

            </div>

        </section>



    </main>

    <script src="/js/cafe-like.js"></script>


    <div style="margin-top:8px; " >
        <h2 th:text="|${cafe.name} ìœ„ì¹˜|" style="" class="map-title">ì¹´í˜ ìœ„ì¹˜</h2>
        <div style="margin-bottom:10px; display:flex; gap:8px">
            <input id="address-input" type="text"
                   th:value="${!#strings.isEmpty(cafe.address1) ? cafe.address1 : cafe.streetAdr}"
                   style="flex:1; padding:8px; border:1px solid var(--line); border-radius:4px"
                   placeholder="ì£¼ì†Œ ê²€ìƒ‰" />
            <button id="search-btn" type="button" class="btn">ê²€ìƒ‰</button>
        </div>

        <div id="map" style="width:100%;height:500px;"></div>

        <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=8ed22f8047c9ec337686bbb083546da6&libraries=services"></script>
        <script>
            var container = document.getElementById('map');
            var options = {
              center: new kakao.maps.LatLng(37.5665, 126.9780), // ì§€ë„ë¥¼ ì—´ ë•Œ ë³´ì¼ ì¢Œí‘œ (ì—¬ê¸°ì„œëŠ” ì„œìš¸ ì‹œì²­)
              level: 3                                          // í™•ëŒ€ ë ˆë²¨(1~14)
            };
            var map = new kakao.maps.Map(container, options);
            var marker = new kakao.maps.Marker({
                map: map
            });

            var places = new kakao.maps.services.Places();

            function searchAndDisplay() {
                var keyword = document.getElementById('address-input').value;
                if (!keyword) return;
                places.keywordSearch(keyword, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        var first = result[0];
                        var coords = new kakao.maps.LatLng(first.y, first.x);
                        map.setCenter(coords);
                        marker.setPosition(coords);
                    }
                });
            }

            document.getElementById('search-btn').addEventListener('click', searchAndDisplay);
            document.getElementById('address-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter') {
                    searchAndDisplay();
                }
            });

            if (document.getElementById('address-input').value) {
                searchAndDisplay();
            }
        </script>
    </div>
    <!-- í•˜ë‹¨: ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ í˜ì´ì§€ë¡œ ì´ë™ (ìŠ¤íƒ€ì¼ ì—†ìŒ) -->
    <!--  ê¸°ë³¸ìˆœ - ìµœì‹ ìˆœ , ì¸ê¸°ìˆœ - ë¦¬ë·° ì¢‹ì•„ìš” ê°¯ìˆ˜ ìˆœ  -->
    <div style="margin-top:16px;">
        <div class="review-summary"><div class="review-header">
            <div class="review-subject">Review (<span th:text="${reviewCount}"></span>)
            </div>
            <form th:action="@{/cafe/detail/{id}(id=${cafe.id})}" id="filterForm" method="get"
                  class="filter-form">
                <label class="filter-bar__sort">
                    <select name="sort" th:value="${sort}" form="filterForm" onchange="this.form.submit()">
                        <option value="createdAt" th:selected="${sort} == 'createdAt'">ìµœì‹ ìˆœ</option>
                        <option value="hit" th:selected="${sort} == 'hit'">ì¸ê¸°ìˆœ</option>
                    </select>
                </label>
            </form>
        </div>
            <div class="review-container">


                <a th:each="review : ${latestReviews}"
                   th:href="@{/cafes/{id}/reviews(id=${cafe.id})}"
                   class="review-item"
                   style="display: block; text-decoration: none; color: inherit;">

                    <div class="review-item-inner">
                        <!--  ëŒ€í‘œ, ëŒ€ì²´ ì´ë¯¸ì§€  -->
                        <div class="review-image-placeholder"></div>
                        <!--                        <div th:if="${#lists.isEmpty(review.images) == false}">-->
                        <!--                            <img th:each="img : ${review.images}"-->
                        <!--                                 th:src="@{/uploads/{file}(file=${img.fileName})}"-->
                        <!--                                 alt="ë¦¬ë·° ì´ë¯¸ì§€" />-->
                        <!--                        </div>-->

                        <div class="review-content">
                            <div class="review-stars">
                                <div class="rating-group">
                                    <!-- 1ë¶€í„° 5ê¹Œì§€ ë°˜ë³µ -->
                                    <span th:each="i : ${#numbers.sequence(1,5)}">
                                    <!-- ê½‰ ì°¬ ë³„ -->
                                    <i class="fa-solid fa-star" th:if="${review.rating >= i}"></i>
                                        <!-- ë°˜ ë³„ -->
                                    <i class="fa-solid fa-star-half-stroke"
                                       th:if="${review.rating >= i - 0.5 and review.rating < i}"></i>
                                        <!-- ë¹ˆ ë³„ -->
                                    <i class="fa-regular fa-star" th:if="${review.rating < i - 0.5}"></i>
                                </span>
                                    <span class="review-score" th:text="${review.rating}"></span>
                                </div>
                                <div class="review-likes-info">
                                    <i class="fa-solid fa-heart" style="color: #eb4747;"></i>
                                    <span th:text="${likeCountMap.get(review.id)} ?: 0">0</span>
                                </div>
                            </div>

                            <span class="review-content-text" th:text="${review.content}"></span>
                        </div>
                    </div>
                </a>

            </div>
            <button type="button" class="more-reviews-button"
                    th:onclick="location.href='/cafes/' + [[${cafe.id}]] + '/reviews'">ë”ë³´ê¸°
            </button>
        </div>
    </div>
</div>
</html>