<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<!-- Î†àÏù¥ÏïÑÏõÉÏù¥ head ÏÇΩÏûÖ Ìè¨Ïù∏Ìä∏Î•º Ï†úÍ≥µÌïòÎäî Í≤ΩÏö∞ -->
<th:block layout:fragment="headExtra">
    <meta charset="UTF-8"/>
    <meta th:if="${_csrf}" name="_csrf" th:content="${_csrf.token}"/>
    <meta th:if="${_csrf}" name="_csrf_header" th:content="${_csrf.headerName}"/>
    <link rel="stylesheet" th:href="@{/css/cafe-detail.css}"/>
</th:block>

<div layout:fragment="content">

    <div class="container">
        <!-- ÏÉÅÎã®: Ïπ¥Ìéò Ï†ïÎ≥¥ -->
        <section class="card">
            <div class="flex between">
                <div>
                    <h2 th:text="${cafe.name}">Ïπ¥Ìéò Ïù¥Î¶Ñ</h2>
                    <div class="muted">
                        <span th:text="${cafe.address1} ?: 'Ï£ºÏÜå Ï†ïÎ≥¥ ÏóÜÏùå'">Ï£ºÏÜå1</span>
                        <span th:if="${cafe.address2}" th:text="| ${cafe.address2}|"></span>
                    </div>
                    <div class="muted" th:if="${cafe.phoneNum}">
                        Ï†ÑÌôî: <span th:text="${cafe.phoneNum}">010-0000-0000</span>
                    </div>
                </div>

                <div style="text-align:right">
                    <div class="rating-badge">
                        ÌèâÍ∑† ‚òÖ
                        <span th:text="${avgRating != null ? #numbers.formatDecimal(avgRating,1,1) : '0.0'}">0.0</span>
                        / 5.0
                    </div>
                    <div class="muted" th:if="${openNow != null}">
            <span class="pill"
                  th:classappend="${openNow} ? ' pill--open' : ' pill--closed'"
                  th:text="${openNow} ? 'ÏòÅÏóÖÏ§ë' : 'ÎßàÍ∞ê'">ÏòÅÏóÖÏÉÅÌÉú</span>
                    </div>
                </div>
            </div>
        </section>

        <!-- Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÎßå: Î¶¨Î∑∞ ÏûëÏÑ± (AJAX Ï†úÏ∂ú) -->
        <section class="card" sec:authorize="isAuthenticated()">
            <h3>Î¶¨Î∑∞ ÏûëÏÑ±</h3>

            <!-- ‚úÖ JSÏóêÏÑú ÏâΩÍ≤å Ï∞∏Ï°∞ÌïòÎèÑÎ°ù id + data-cafe-id Î∂ÄÏó¨ -->
            <form id="reviewCreateForm"
                  th:action="@{/cafes/{id}/reviews(id=${cafe.id})}"
                  th:attr="data-cafe-id=${cafe.id}"
                  method="post">
                <input th:if="${_csrf}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <div class="form-row">
                    <label for="rating">Î≥ÑÏ†ê (1.0~5.0, 0.5Îã®ÏúÑ)</label>
                    <input id="rating" name="rating" type="number" step="0.5" min="1.0" max="5.0" value="4.0" required/>
                </div>

                <div class="form-row">
                    <label for="content">ÎÇ¥Ïö© (ÏµúÏÜå 5Ïûê)</label>
                    <textarea id="content" name="content" minlength="5f" maxlength="4000"
                              placeholder="Ïπ¥Ìéò Ïù¥Ïö© Í≤ΩÌóòÏùÑ Íµ¨Ï≤¥Ï†ÅÏúºÎ°ú ÏûëÏÑ±Ìï¥ Ï£ºÏÑ∏Ïöî." required></textarea>
                </div>

                <div class="form-row">
                    <label>Ïù¥ÎØ∏ÏßÄ URL (ÏµúÎåÄ 5Í∞ú)</label>
                    <div class="url-grid">
                        <input type="url" name="imageUrl" placeholder="https://...">
                        <input type="url" name="imageUrl" placeholder="https://...">
                        <input type="url" name="imageUrl" placeholder="https://...">
                        <input type="url" name="imageUrl" placeholder="https://...">
                        <input type="url" name="imageUrl" placeholder="https://...">
                    </div>
                </div>

                <div class="mt-10">
                    <button class="btn" type="submit">Îì±Î°ù</button>
                </div>
            </form>
        </section>

        <!-- Î¶¨Î∑∞ Î¶¨Ïä§Ìä∏ (ÌîÑÎûòÍ∑∏Î®ºÌä∏ + ÍµêÏ≤¥ ÌÉÄÍ≤ü) -->
        <section class="card" id="reviewsSection" th:fragment="reviews_section">
            <div class="flex between">
                <h3>Î¶¨Î∑∞</h3>
                <div class="muted" th:if="${reviews != null}">
                    ÌéòÏù¥ÏßÄ <span th:text="${reviews.number + 1}">1</span> / <span th:text="${reviews.totalPages}">1</span>
                </div>
            </div>

            <div class="grid" th:if="${reviews != null and reviews.totalElements > 0}">
                <article th:each="rv : ${reviews.content}" class="review-item">
                    <div class="flex between">
                        <h4>
                            <span class="pill" th:text="${rv.author != null ? rv.author.username : 'Ïïå Ïàò ÏóÜÏùå'}">ÏûëÏÑ±Ïûê</span>
                            <span class="stars">‚òÖ</span>
                            <span th:text="${#numbers.formatDecimal(rv.rating,1,1)}">4.0</span>
                        </h4>
                        <time class="muted" th:text="${#temporals.format(rv.createdAt,'yyyy-MM-dd HH:mm')}">2025-09-01</time>
                    </div>

                    <p th:text="${rv.content}">Î¶¨Î∑∞ ÎÇ¥Ïö©</p>

                    <div class="grid grid-cols-3" th:if="${rv.images != null and !rv.images.isEmpty()}">
                        <img th:each="img : ${rv.images}"
                             th:src="${img.imageUrl}"
                             alt="review image"
                             class="img-thumb"/>
                    </div>

                    <div class="flex between mt-8">
                        <div>
                            <form th:action="@{|/reviews/${rv.id}/like|}" method="post" style="display:inline;">
                                <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn ghost" type="submit">üëç Ï¢ãÏïÑÏöî</button>
                            </form>
                            <form th:action="@{|/reviews/${rv.id}/unlike|}" method="post" style="display:inline; margin-left:6px;">
                                <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="btn ghost" type="submit">‚Ü© Ï∑®ÏÜå</button>
                            </form>
                            <span class="muted" style="margin-left:8px;">‚ô° <b th:text="${rv.likeCount}">0</b></span>
                        </div>
                        <div>
                            <a class="btn ghost" th:href="@{|/reviews/${rv.id}|}">ÏÉÅÏÑ∏Î≥¥Í∏∞</a>
                        </div>
                    </div>
                </article>

                <nav class="pagination" th:if="${reviews.totalPages > 1}">
                    <a th:if="${reviews.hasPrevious()}"
                       th:href="@{/cafe/detail/{id}(id=${cafe.id}, rpage=${reviews.number - 1}, rsize=${reviews.size})}">&laquo; Ïù¥Ï†Ñ</a>

                    <span th:each="p : ${#numbers.sequence(0, reviews.totalPages - 1)}"
                          th:classappend="${p} == ${reviews.number} ? 'active'">
            <a th:if="${p} != ${reviews.number}"
               th:href="@{/cafe/detail/{id}(id=${cafe.id}, rpage=${p}, rsize=${reviews.size})}"
               th:text="${p+1}">1</a>
            <span th:if="${p} == ${reviews.number}" th:text="${p+1}">1</span>
          </span>

                    <a th:if="${reviews.hasNext()}"
                       th:href="@{/cafe/detail/{id}(id=${cafe.id}, rpage=${reviews.number + 1}, rsize=${reviews.size})}">Îã§Ïùå &raquo;</a>
                </nav>
            </div>

            <div th:if="${reviews == null || reviews.totalElements == 0}" class="muted">
                ÏïÑÏßÅ ÏûëÏÑ±Îêú Î¶¨Î∑∞Í∞Ä ÏóÜÏñ¥Ïöî.
            </div>
        </section>
    </div>

</div>

<!-- Î†àÏù¥ÏïÑÏõÉÏù¥ body-end ÏÇΩÏûÖ Ìè¨Ïù∏Ìä∏Î•º Ï†úÍ≥µÌïòÎäî Í≤ΩÏö∞ -->
<th:block layout:fragment="bodyEndExtra">
    <script th:src="@{/js/cafe-detail.js}" defer></script>
</th:block>

</html>
