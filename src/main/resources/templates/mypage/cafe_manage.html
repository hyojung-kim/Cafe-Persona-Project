<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8" />
    <title>사업장 관리</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" th:href="@{/css/cafe-manage.css}">
</head>
<div layout:fragment="content">
<body>

<div class="g-container" th:with="biz=${user != null and user.businessUser != null ? user.businessUser : null}">
    <!-- 헤더 -->
    <div class="header">
        <div>
            <h1 class="title">사업장 관리</h1>
            <p class="subtitle">메뉴·운영시간·사진을 <br> 손쉽게 업데이트하세요.</p>
        </div>

        <div style="display:flex; gap:10px; align-items:center">
            <!-- 등록된 상태면 '수정하기', 아니면 '등록하기' -->
            <a class="btn"
               th:href="${cafe != null} ? @{/mypage/cafe/edit/{id}(id=${cafe.id})} : @{/mypage/cafe/register}"
               th:text="${cafe != null} ? '사업장 수정하기' : '사업장 등록하기'">
                사업장 등록하기
            </a>
        </div>
    </div>



    <div class="grid grid-cols-3" style="margin-top:16px">

        <!-- 지표 영역 -->
        <section class="stats-area">
            <div class="card">
                <h3>핵심 지표</h3>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="k">북마크</div>
                        <div class="v" th:text="${bookmarkCount != null ? bookmarkCount : 0}">0</div>
                    </div>
                    <div class="stat">
                        <div class="k">리뷰 수</div>
                        <div class="v" th:text="${reviewCount != null ? reviewCount : 0}">0</div>
                    </div>
                    <div class="stat">
                        <div class="k">평균 평점</div>
                        <div class="v" th:text="${avgRating != null ? #numbers.formatDecimal(avgRating,1,1) : '—'}">—</div>
                    </div>
                </div>
            </div>

            <div class="card" style="margin-top:16px">
                <h3>최근 리뷰</h3>

                <!-- ✅ 실제 데이터 -->
                <div class="item" th:each="rv : ${recentReviews}">
                    <div>
                        <div style="font-weight:700">
                            <span th:text="${#strings.abbreviate(rv.content, 40)}">리뷰 내용</span>
                            <span class="star">★ <span th:text="${#numbers.formatDecimal(rv.rating,1,1)}">0.0</span></span>
                        </div>
                        <div class="muted">
                            <span th:text="${rv.user != null ? rv.user.nickname : '탈퇴회원'}">user123</span>
                            · <span th:text="${#temporals.format(rv.createdAt,'yyyy-MM-dd')}">2025-09-05</span>
                        </div>
                    </div>
                </div>

                <!-- 비어 있을 때 -->
                <div class="item" th:if="${#lists.isEmpty(recentReviews)}">
                    최근 등록된 리뷰가 없습니다.
                </div>

                <div class="divider"></div>
                <div style="display:flex; justify-content:flex-end">
                    <a class="btn secondary"
                       th:href="@{/cafes/{cid}/reviews(cid=${cafe.id})}">
                        전체 리뷰 보기
                    </a>
                </div>
            </div>



            <div class="card" style="margin-top:16px">
                <h3>공지 & 프로모션</h3>
                <div class="item">
                    <div style="flex:1">
                        <div><span class="chip">이벤트</span> 9월 신메뉴 2+1</div>
                        <div class="muted">2025-09-01 ~ 2025-09-30</div>
                    </div>
                    <div class="ok">진행중</div>
                </div>
                <div class="item">
                    <div style="flex:1">
                        <div><span class="chip">공지</span> 추석 연휴 휴무 안내</div>
                        <div class="muted">2025-09-14 ~ 2025-09-16</div>
                    </div>
                    <div class="warn">예정</div>
                </div>

                <div class="divider"></div>
                <div style="display:flex; gap:8px; justify-content:flex-end">
                    <a class="btn secondary" th:href="@{/mypage/cafe/promotions}">목록 보기</a>
                    <a class="btn" th:href="@{/mypage/cafe/promotions/new}">새 프로모션</a>
                </div>
            </div>
        </section>



        <!-- 리스트/미리보기 기타 영역 -->
        <section class="lists-area">
            <!-- 메뉴 요약 카드 (기존 더미 교체) -->
            <div class="card">
                <h3>메뉴 요약</h3>


                <div id="menuSummary">
                    <div class="item" th:each="m : ${menusLimited}">
                        <div style="flex:1">
                            <div style="font-weight:700" th:text="${m.name}">메뉴명</div>
                            <div class="muted">
                                <span th:text="${m.description != null ? m.description : '설명 없음'}">설명 없음</span>
                                · <span th:text="${#numbers.formatInteger(m.price, 3, 'COMMA')} + '원'">5,000원</span>
                            </div>
                        </div>
                        <span class="chip">판매중</span>
                    </div>

                    <div class="item" th:if="${menusLimited == null or #lists.isEmpty(menusLimited)}">
                        등록된 메뉴가 없습니다.
                    </div>
                </div>

                <div class="divider"></div>
                <div style="display:flex; justify-content:flex-end">
                    <button type="button" class="btn secondary" onclick="openMenuModal()">메뉴 등록 및 삭제</button>
                </div>
            </div>


            <!-- ========= 전체 메뉴 모달 ========= -->
            <div id="menuModal" class="modal" style="display:none;">
                <div class="modal__backdrop" onclick="closeMenuModal()"></div>
                <div class="modal__panel">
                    <div class="modal__header">
                        <h3>전체 메뉴</h3>
                        <button type="button" class="modal__close" aria-label="닫기" onclick="closeMenuModal()">×</button>
                    </div>

                    <div class="modal__body">
                        <!-- 목록 -->
                        <div id="menuList" class="menu-list"></div>

                        <div class="divider" style="margin:12px 0;"></div>

                        <!-- 등록 폼 -->
                        <form id="menuForm" onsubmit="return false;" class="menu-form">
                            <!-- cafeId는 서버에서 내려줌 -->
                            <input type="hidden" id="cafeId" th:value="${cafe != null ? cafe.id : 0}"/>

                            <div class="row" style="display:grid; grid-template-columns:1fr 120px 1fr 100px; gap:8px;">
                                <div>
                                    <label for="menuName">메뉴 이름</label>
                                    <input id="menuName" type="text" placeholder="예) 아메리카노" required>
                                </div>
                                <div>
                                    <label for="menuPrice">가격</label>
                                    <input id="menuPrice" type="number" min="0" step="100" placeholder="예) 4500" required>
                                </div>
                                <div>
                                    <label for="menuDesc">설명</label>
                                    <input id="menuDesc" type="text" placeholder="예) 깊은 바디감">
                                </div>
                                <div style="display:flex; align-items:flex-end;">
                                    <button id="menuSubmitBtn" type="button" class="btn" onclick="doSubmitMenu()">등록</button>

                                </div>
                            </div>
                        </form>
                    </div>

                    <div class="modal__footer" style="text-align:right;">
                        <button type="button" class="btn secondary" onclick="closeMenuModal()">닫기</button>
                    </div>
                </div>
            </div>




            <div class="card" style="margin-top:16px">
                <h3>사진 갤러리</h3>

                <!-- 사진이 있을 때 -->
                <div th:if="${photos != null and !photos.isEmpty()}"
                     class="gallery-grid hero__imgwrap">
                    <div th:each="p : ${photos}" class="gallery-item">
                        <img th:src="@{${p.imgUrl}}" alt="카페 이미지" class="hero__img">

                        <!-- ② 정적 경로/스토리지 경로가 있다면 -->
                        <!-- <img th:src="@{|/uploads/${p.storagePath}|}" alt="카페 이미지"> -->
                    </div>
                </div>

                <!-- 사진이 없을 때 빈 상태 -->
                <div th:if="${photos == null or photos.isEmpty()}" class="empty">
                    등록된 사진이 없습니다.
                </div>

                <div class="divider"></div>
                <div style="display:flex; justify-content:flex-end">
                    <a class="btn secondary" th:href="@{/mypage/cafe/photos}">사진 관리</a>
                </div>
            </div>
        </section>

    </div>
</div>

<!-- JS 연결 -->
<script src="/js/cafe_manage.js?v=DEV1"></script>
</body>
</div>
</html>
