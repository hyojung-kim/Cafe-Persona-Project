<!DOCTYPE html>
<html layout:decorate="~{layout}" xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8"/>
    <title>사업장 등록</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <link rel="stylesheet" th:href="@{/css/cafe-register.css}">
</head>

<body>
<div layout:fragment="content" class="page--with-navbar">
    <div class="regis-container">

        <!-- 헤더 -->
        <div class="card page-header">
            <h1 th:text="${mode}=='edit' ? '사업장 수정' : '사업장 등록'">사업장 등록</h1>
            <p>기본 정보만 먼저 등록하세요. <br> 상세 정보(메뉴/운영시간/사진)는 이후에 추가할 수 있어요.</p>
        </div>

        <!-- 알림 -->
        <div th:if="${toast}" class="card alert alert-success">
            <span th:text="${toast}">등록되었습니다.</span>
        </div>
        <div th:if="${errorMessage != null}" class="card alert alert-error">
            <span th:text="${errorMessage}">오류가 발생했습니다.</span>
        </div>


        <!-- 폼 -->
        <div class="card register-form">
            <form method="post" enctype="multipart/form-data" autocomplete="on"
                  th:action="${mode}=='edit' ? @{/mypage/cafe/update} : @{/mypage/cafe/register}">

                <!-- CSRF -->
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

                <!-- 편집 모드: cafeId 유지 -->
                <input type="hidden" name="cafeId"
                       th:if="${mode}=='edit' and cafe != null"
                       th:value="${cafe.id}"/>

                <!-- 사업자번호(선택) -->
                <input type="hidden" name="businessNumber"
                       th:value="${user != null and user.businessUser != null ? user.businessUser.businessNumber : ''}"/>

                <div class="grid-cols">
                    <!-- 좌 -->
                    <div class="col">
                        <div class="form-group">
                            <label for="companyName">상호명(회사명) <span class="required">*</span></label>
                            <input id="companyName" name="name" type="text" required
                                   placeholder="예) 빈스팟 커피"
                                   th:value="${form?.name != null ? form.name : (biz != null ? biz.companyName : '')}"/>
                        </div>

                        <div class="form-group">
                            <label for="representativeName">대표자 이름</label>
                            <input id="representativeName" name="representativeName" type="text"
                                   placeholder="예) 홍길동"
                                   th:value="${biz?.representativeName}"/>
                        </div>

                        <div class="form-group">
                            <label for="representativeEmail">대표자 이메일</label>
                            <input id="representativeEmail" name="representativeEmail" type="email"
                                   placeholder="you@example.com"
                                   th:value="${biz?.representativeEmail}"/>
                        </div>

                        <div class="form-group">
                            <label for="representativePhone">대표자 연락처</label>
                            <input id="representativePhone" name="phoneNum" type="tel"
                                   placeholder="010-1234-5678"
                                   th:value="${form?.phoneNum != null ? form.phoneNum : (biz?.representativePhone)}"/>
                        </div>
                    </div>

                    <!-- 우 -->
                    <div class="col">
                        <div class="form-group">
                            <label for="address">사업장 주소</label>
                            <input id="address" name="address1" type="text"
                                   placeholder="예) 서울특별시 강남구 테헤란로..."
                                   th:value="${form?.address1 != null ? form.address1 : (biz?.address)}"/>

                            <input name="address2" type="text" placeholder="상세 주소" style="margin-top:8px;"
                                   th:value="${form?.address2 != null ? form.address2 : (biz?.address2)}"/>
                        </div>

                        <div class="form-group" style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                            <input name="openTime" type="time" placeholder="영업 시작"
                                   th:value="${form?.openTime != null ? #temporals.format(form.openTime,'HH:mm') : ''}"/>
                            <input name="closeTime" type="time" placeholder="영업 종료"
                                   th:value="${form?.closeTime != null ? #temporals.format(form.closeTime,'HH:mm') : ''}"/>
                        </div>

                        <div class="form-group" style="display:flex; gap:12px; align-items:center;">
                            <label style="margin-right:8px;">주차 가능 여부</label>
                            <label style="display:flex; align-items:center; gap:6px;">
                                <input type="checkbox" class="parking" name="parkingYn" th:checked="${form != null and form.parkingYn}"/>
                            </label>
                        </div>

                        <!-- 새 사진 등록 -->
                        <div class="form-group">
                            <label>가게 사진</label>

                            <!-- label-for 패턴: 클릭만으로 파일창 오픈 -->
                            <div style="display:flex; gap:8px;">
                                <label for="photos" class="photo_input_btn" id="btn-photo-pick" style="cursor:pointer;">사진 등록하기</label>
                                <small class="text-muted">JPG/PNG 권장, 최대 10장 · 1장당 5MB 이내,</small>
                                <small class="text-muted">첫 번째 사진이 대표 이미지로 등록됩니다.</small>

                            </div>

                            <!-- 실제 파일 인풋: hidden 대신 CSS로 오프스크린 -->
                            <input type="file"
                                   id="photos"
                                   name="photos"
                                   accept="image/*"
                                   multiple
                                   style="position:absolute;left:-9999px;width:1px;height:1px;opacity:0;">

                            <!-- 신규 프리뷰 -->
                            <div id="photo-preview" class="photo-preview-grid" style="margin-top:10px;"></div>
                        </div>

                        <!-- 기존 사진(편집 모드) -->
                        <div class="form-group" th:if="${mode}=='edit'">
                            <label>기존 사진 (<span th:text="${photoCount}">0</span>)</label>

                            <div class="photo-grid-existing"
                                 style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px;">

                                <div class="photo-card" th:each="p : ${photos}"
                                     style="border:1px solid #ddd;border-radius:8px;overflow:hidden;background:#fafafa;display:flex;flex-direction:column;">

                                    <!-- 이미지 -->
                                    <img th:src="@{${p.imgUrl}}" alt="등록된 사진"
                                         style="width:100%;height:85px;object-fit:cover;display:block;"/>

                                    <!-- 버튼을 이미지 밑으로 이동 -->
                                    <div style="padding:6px;text-align:center;background:#fff;">
                                        <button type="button"
                                                class="btn btn-danger btn-sm"
                                                th:attr="data-delete-url=@{/api/mypage/cafe/photo/{id}(id=${p.id})}"
                                                onclick="deletePhoto(this)">
                                            삭제
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>




                        <div class="form-group">
                            <label for="intro">소개/설명</label>
                            <textarea id="intro" name="intro" rows="6" placeholder="가게 소개..."
                                      th:text="${form?.intro != null ? form.intro : (cafe?.intro != null ? cafe.intro : '')}"></textarea>
                        </div>
                    </div>
                </div>

                <!-- 액션 -->
                <div class="actions">
                    <button type="submit" class="btn"
                            th:text="${mode}=='edit' ? '수정하기' : '등록하기'">등록하기</button>

                    <a class="btn btn-secondary"
                       th:if="${mode}=='edit' and cafe != null"
                       th:href="@{/mypage/cafe/manage(cafeId=${cafe.id})}">
                        관리 페이지로
                    </a>
                </div>

                <!-- JS에서 쓰는 CSRF 헤더/토큰 -->
                <input type="hidden" id="csrfHeaderName" th:value="${_csrf.headerName}">
                <input type="hidden" id="csrfToken" th:value="${_csrf.token}">
            </form>
        </div>
    </div>

    <!-- JS -->
    <script th:src="@{/js/cafe-register.js}" defer></script>
</div>
</body>
</html>
