<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<th:block layout:fragment="headExtra">
  <meta charset="UTF-8"/>
  <title th:text="|리뷰 목록 - ${cafe.name}|">리뷰 목록</title>
  <link rel="stylesheet" th:href="@{/css/review-list.css}"/>
</th:block>

<div layout:fragment="content" class="container mt-4 review-page">

  <!-- 상단 요약 -->
  <section id="reviewsSummary"
           th:fragment="summary"
           class="card shadow-sm mb-3 review-section"
           th:attr="data-review-summary-url=@{|/cafes/${cafe.id}/reviews/summary|}">
    <div class="card-body">
      <div class="d-flex justify-content-between">
        <div>
          <h2 class="h4 mb-1" th:text="${cafe.name}">카페명</h2>
          <div class="text-muted small">
            평균
            <span class="rate read-only" th:with="ar=${avgRating != null ? T(java.lang.Math).round(avgRating * 2) / 2.0 : 0}">
              <input type="radio" id="avg-rating10" value="5.0" th:checked="${ar == 5.0}"><label for="avg-rating10" title="5점"></label>
              <input type="radio" id="avg-rating9" value="4.5" th:checked="${ar == 4.5}"><label class="half" for="avg-rating9" title="4.5점"></label>
              <input type="radio" id="avg-rating8" value="4.0" th:checked="${ar == 4.0}"><label for="avg-rating8" title="4점"></label>
              <input type="radio" id="avg-rating7" value="3.5" th:checked="${ar == 3.5}"><label class="half" for="avg-rating7" title="3.5점"></label>
              <input type="radio" id="avg-rating6" value="3.0" th:checked="${ar == 3.0}"><label for="avg-rating6" title="3점"></label>
              <input type="radio" id="avg-rating5" value="2.5" th:checked="${ar == 2.5}"><label class="half" for="avg-rating5" title="2.5점"></label>
              <input type="radio" id="avg-rating4" value="2.0" th:checked="${ar == 2.0}"><label for="avg-rating4" title="2점"></label>
              <input type="radio" id="avg-rating3" value="1.5" th:checked="${ar == 1.5}"><label class="half" for="avg-rating3" title="1.5점"></label>
              <input type="radio" id="avg-rating2" value="1.0" th:checked="${ar == 1.0}"><label for="avg-rating2" title="1점"></label>
              <input type="radio" id="avg-rating1" value="0.5" th:checked="${ar == 0.5}"><label class="half" for="avg-rating1" title="0.5점"></label>
            </span>
            <span class="ms-1" th:text="${avgRating != null ? #numbers.formatDecimal(avgRating,1,1) : '0.0'}">0.0</span> / 5.0
            <span class="ms-2">리뷰 <b th:text="${reviewCount}">0</b>개</span>
          </div>
        </div>
        <div class="text-end">
          <a th:href="@{|/cafe/detail/${cafe.id}|}" class="btn btn-outline-secondary btn-sm">카페 상세</a>
        </div>
      </div>

      <div class="review-image-slider mt-3" th:if="${topReviewImages != null and !#lists.isEmpty(topReviewImages)}" data-visible="4">
        <div class="slider-track">
          <div class="slide" th:each="img : ${topReviewImages}">
            <img th:src="@{${img}}" alt="top review image" class="review-image"/>
          </div>
        </div>
        <button class="slider-btn prev-btn" type="button">&#10094;</button>
        <button class="slider-btn next-btn" type="button">&#10095;</button>
      </div>
    </div>
  </section>

  <div id="certifySuccessMessage" class="alert alert-success d-none" role="alert">
    위치 인증이 완료되었습니다. 이제 리뷰를 작성할 수 있습니다.
  </div>

  <!-- 작성 폼 -->
  <section class="card shadow-sm mb-3 review-section" sec:authorize="isAuthenticated()">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h3 class="h6 mb-0">리뷰 작성</h3>
        <a th:href="@{|/cafes/${cafe.id}/reviews/location|}" class="btn btn-outline-success btn-sm">위치 인증</a>
      </div>
      <form id="reviewCreateForm"
            th:action="@{/cafes/{id}/reviews(id=${cafe.id})}"
            th:data-cafe-id="${cafe.id}"
            method="post"
            enctype="multipart/form-data"
            class="needs-validation" novalidate>
        <input th:if="${_csrf}" type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <div class="row g-1 align-items-stretch">
          <div class="col-12 col-md-2 d-flex flex-column justify-content-between">
            <div class="rate align-self-start">
              <input type="radio" id="create-rating10" name="rating" value="5.0"><label for="create-rating10" title="5점"></label>
              <input type="radio" id="create-rating9" name="rating" value="4.5"><label class="half" for="create-rating9" title="4.5점"></label>
              <input type="radio" id="create-rating8" name="rating" value="4.0" checked><label for="create-rating8" title="4점"></label>
              <input type="radio" id="create-rating7" name="rating" value="3.5"><label class="half" for="create-rating7" title="3.5점"></label>
              <input type="radio" id="create-rating6" name="rating" value="3.0"><label for="create-rating6" title="3점"></label>
              <input type="radio" id="create-rating5" name="rating" value="2.5"><label class="half" for="create-rating5" title="2.5점"></label>
              <input type="radio" id="create-rating4" name="rating" value="2.0"><label for="create-rating4" title="2점"></label>
              <input type="radio" id="create-rating3" name="rating" value="1.5"><label class="half" for="create-rating3" title="1.5점"></label>
              <input type="radio" id="create-rating2" name="rating" value="1.0"><label for="create-rating2" title="1점"></label>
              <input type="radio" id="create-rating1" name="rating" value="0.5"><label class="half" for="create-rating1" title="0.5점"></label>
            </div>
            <button class="btn btn-primary btn-sm review-submit-btn mt-2 mt-md-auto" type="submit">등록</button>
          </div>
          <div class="col-12 col-md-7">
            <textarea id="content" name="content" class="form-control" minlength="5" maxlength="4000" rows="4" placeholder="위치 인증 후, 후기를 입력하세요(최소 5자)" required></textarea>
          </div>
          <div class="col-12 col-md-3">
            <input type="file" name="images" class="form-control" accept="image/*" multiple>
          </div>
        </div>
      </form>
    </div>
  </section>

  <!-- 리뷰 검색 및 정렬 -->
  <section class="card shadow-sm mb-3 review-section">
    <div class="card-body d-flex justify-content-between align-items-center">
      <div class="btn-group btn-group-sm review-sort-group" role="group">
        <a class="btn btn-outline-secondary"
           th:classappend="${sort} == 'likes' ? 'active'"
           th:href="@{/cafes/{id}/reviews(id=${cafe.id}, sort='likes', keyword=${keyword})}">좋아요순</a>
        <a class="btn btn-outline-secondary"
           th:classappend="${sort} != 'likes' ? 'active'"
           th:href="@{/cafes/{id}/reviews(id=${cafe.id}, sort='latest', keyword=${keyword})}">최신순</a>
      </div>
      <form id="reviewSearchForm" th:action="@{/cafes/{id}/reviews(id=${cafe.id})}" method="get" class="d-flex">
        <input type="hidden" name="sort" th:value="${sort}">
        <input type="text" name="keyword" class="form-control review-search-input" placeholder="리뷰 검색"
               th:value="${keyword}">
        <button class="btn btn-outline-secondary btn-sm ms-1 review-search-btn" type="submit">검색</button>
      </form>
    </div>
  </section>

  <!-- 리뷰 리스트 섹션 (프래그먼트) -->
  <section id="reviewsSection"
           th:fragment="section"
           class="card shadow-sm review-section"
           th:attr="data-review-section-url=@{|/cafes/${cafe.id}/reviews/section?rpage=${page.number}&rsize=${page.size}&keyword=${keyword != null ? keyword : ''}&sort=${sort}|}">
    <div class="card-body">

      <div class="d-flex justify-content-between align-items-center mb-2">
        <h3 class="h6 mb-0">리뷰</h3>
        <div class="text-muted small">
          페이지 <span th:text="${page.number + 1}">1</span> / <span th:text="${page.totalPages}">1</span>
        </div>
      </div>

      <div class="row g-3" th:if="${page != null and page.totalElements > 0}">
        <article th:each="rv : ${page.content}" class="col-12">
          <div class="review-card p-3 h-100">
            <div class="d-flex justify-content-between">
              <h4 class="h6 mb-0">
                <span class="badge bg-info text-dark"
                      th:text="${rv.user != null ? rv.user.nickname : '알 수 없음'}">작성자</span>
                <span class="rate read-only ms-2" th:with="r=${rv.rating}">
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating10'" value="5.0" th:checked="${r == 5.0}"><label th:for="'rv' + ${rv.id} + '-rating10'" title="5점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating9'" value="4.5" th:checked="${r == 4.5}"><label class="half" th:for="'rv' + ${rv.id} + '-rating9'" title="4.5점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating8'" value="4.0" th:checked="${r == 4.0}"><label th:for="'rv' + ${rv.id} + '-rating8'" title="4점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating7'" value="3.5" th:checked="${r == 3.5}"><label class="half" th:for="'rv' + ${rv.id} + '-rating7'" title="3.5점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating6'" value="3.0" th:checked="${r == 3.0}"><label th:for="'rv' + ${rv.id} + '-rating6'" title="3점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating5'" value="2.5" th:checked="${r == 2.5}"><label class="half" th:for="'rv' + ${rv.id} + '-rating5'" title="2.5점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating4'" value="2.0" th:checked="${r == 2.0}"><label th:for="'rv' + ${rv.id} + '-rating4'" title="2점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating3'" value="1.5" th:checked="${r == 1.5}"><label class="half" th:for="'rv' + ${rv.id} + '-rating3'" title="1.5점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating2'" value="1.0" th:checked="${r == 1.0}"><label th:for="'rv' + ${rv.id} + '-rating2'" title="1점"></label>
                  <input type="radio" th:id="'rv' + ${rv.id} + '-rating1'" value="0.5" th:checked="${r == 0.5}"><label class="half" th:for="'rv' + ${rv.id} + '-rating1'" title="0.5점"></label>
                </span>
              </h4>
              <time class="text-muted small"
                    th:text="${#temporals.format(rv.createdAt,'yyyy-MM-dd HH:mm')}">2025-09-01</time>
            </div>
            <!-- 리뷰 내용이 너무 많이 표시 돼서 타임리프 문법으로 리스트에서만 줄여버림 -->
            <p class="mt-2 mb-2" th:text="${#strings.abbreviate(rv.content, 300)}">리뷰 내용</p>

            <div class="row g-2 mt-1" th:if="${rv.images != null and !rv.images.isEmpty()}">
              <div class="col-auto">
                <a th:href="@{|/reviews/${rv.id}|}" class="d-block">
                  <div class="review-image-wrapper">
                    <img th:src="@{${rv.images[0].imageUrl}}" alt="review image" class="review-image">
                  </div>
                </a>
              </div>
              <div class="col-auto">
                <a th:href="@{|/reviews/${rv.id}|}" class="d-block">
                  <div class="review-image-more">이미지 더보기...</div>
                </a>
              </div>
            </div>

            <div class="d-flex align-items-center mt-3">
              <div class="review-like-box"
                   th:with="isLiked=${likedMap[rv.id] != null ? likedMap[rv.id] : false}"
                   th:data-review-id="${rv.id}"
                   th:data-liked="${isLiked}">
                <button type="button"
                        class="btn_like review-like-btn"
                        th:classappend="${isLiked} ? ' on' : ''"
                        data-label-like="좋아요"
                        data-label-unlike="좋아요 취소"
                        th:attr="aria-pressed=${isLiked}, aria-label=${isLiked} ? '좋아요 취소' : '좋아요'">
                  좋아요
                </button>
                <span class="review-like-count ms-1" th:text="${likeCountMap[rv.id]}">0</span>
              </div>
              <div class="ms-auto text-end">
                <a class="btn btn-sm btn-outline-primary" th:href="@{|/reviews/${rv.id}|}">상세보기</a>
                <a th:if="${me != null && (me.id == rv.user?.id or me.role == 'ADMIN' or me.role == 'ROLE_ADMIN')}" class="btn btn-sm btn-secondary ms-1" th:href="@{|/reviews/${rv.id}/edit|}">수정</a>
                <form th:if="${me != null && (me.id == rv.user?.id or me.role == 'ADMIN' or me.role == 'ROLE_ADMIN')}" th:action="@{|/reviews/${rv.id}/delete|}" method="post" class="d-inline ms-1" onsubmit="return confirm('정말 삭제하시겠습니까?');">
                  <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                  <button type="submit" class="btn btn-sm btn-danger">삭제</button>
                </form>
              </div>
            </div>
          </div>
        </article>
      </div>

      <nav class="pagination review-pagination" aria-label="페이지 이동" th:if="${page != null and page.totalPages > 1}">
        <a class="page-btn" th:href="@{/cafes/{id}/reviews/section(id=${cafe.id}, rpage=0, rsize=${page.size}, keyword=${keyword}, sort=${sort})}" aria-label="첫 페이지">«</a>
        <a class="page-btn" th:if="${page.hasPrevious()}" th:href="@{/cafes/{id}/reviews/section(id=${cafe.id}, rpage=${page.number - 1}, rsize=${page.size}, keyword=${keyword}, sort=${sort})}" aria-label="이전 페이지">이전</a>

        <ol class="page-list" role="list">
          <li th:each="p : ${#numbers.sequence(0, page.totalPages - 1)}" th:if="${p >= page.number-1 and p <= page.number+1}">
            <a class="page-link" th:if="${p} != ${page.number}" th:text="${p+1}" th:href="@{/cafes/{id}/reviews/section(id=${cafe.id}, rpage=${p}, rsize=${page.size}, keyword=${keyword}, sort=${sort})}">1</a>
            <span class="page-link is-current" th:if="${p} == ${page.number}" th:text="${p+1}">1</span>
          </li>
        </ol>

        <a class="page-btn" th:if="${page.hasNext()}" th:href="@{/cafes/{id}/reviews/section(id=${cafe.id}, rpage=${page.number + 1}, rsize=${page.size}, keyword=${keyword}, sort=${sort})}" aria-label="다음 페이지">다음</a>
        <a class="page-btn" th:href="@{/cafes/{id}/reviews/section(id=${cafe.id}, rpage=${page.totalPages - 1}, rsize=${page.size}, keyword=${keyword}, sort=${sort})}" aria-label="마지막 페이지">»</a>
      </nav>

      <div th:if="${page == null || page.totalElements == 0}" class="text-muted">
        아직 작성된 리뷰가 없어요.
      </div>
    </div>
  </section>

  <!-- ✅ 레이아웃 삽입 슬롯을 못 쓰더라도 여기서 직접 로드 -->
  <script th:src="@{/js/review-image-slider.js}" defer></script>
  <script th:src="@{/js/review-like.js}" defer></script>
  <script th:src="@{/js/review-list.js}" defer></script>
  <script th:src="@{/js/reviews-section.js}" defer></script>
</div>

</html>