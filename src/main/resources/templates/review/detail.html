<!-- templates/review/detail.html -->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title>리뷰 상세</title>

  <meta name="_csrf" th:content="${_csrf.token}"/>
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

  <style>
    :root { --gap: 12px; --bd: 1px solid #e5e7eb; }
    body{font-family:system-ui,apple-system,Segoe UI,Roboto,Pretendard,Arial,sans-serif; margin:0; padding:24px; background:#fafafa; color:#111827;}
    .container{max-width:840px; margin:0 auto;}
    .card{background:#fff; border:var(--bd); border-radius:14px; padding:20px; box-shadow:0 1px 2px rgba(0,0,0,.04); margin-bottom:16px;}
    .flex{display:flex; gap:12px; align-items:center;}
    .between{justify-content:space-between;}
    .pill{display:inline-block; padding:4px 10px; border-radius:999px; background:#f3f4f6; font-size:12px; color:#374151;}
    .muted{color:#6b7280;}
    .btn{border:var(--bd); background:#111827; color:#fff; padding:8px 14px; border-radius:10px; cursor:pointer;}
    .btn.ghost{background:#fff; color:#111827;}
    .btn.danger{background:#dc2626; border-color:#dc2626;}
    .grid{display:grid; gap:12px;}
    .grid-cols-3{grid-template-columns:repeat(3,1fr);}
    .img{width:100%; height:240px; object-fit:cover; border-radius:10px; border:var(--bd);}
  </style>
</head>
<body>
<div class="container">
  <div class="card">
    <div class="flex between">
      <h2>리뷰 상세</h2>
      <div class="muted">
        조회수 <b th:text="${review.viewCount}">0</b>
      </div>
    </div>

    <div class="flex between">
      <div>
        <span class="pill" th:text="${review.author.username}">writer</span>
        <span class="pill">★ <b th:text="${#numbers.formatDecimal(review.rating,1,1)}">4.0</b> / 5.0</span>
      </div>
      <div class="muted" th:text="${#temporals.format(review.createdAt,'yyyy-MM-dd HH:mm')}">2025-09-01</div>
    </div>

    <p style="white-space:pre-wrap;" th:text="${review.content}">내용</p>

    <div class="grid grid-cols-3" th:if="${review.images != null and !review.images.isEmpty()}">
      <img th:each="img : ${review.images}" th:src="${img.urlPath}" alt="review image" class="img"/>
    </div>

    <div class="flex between" style="margin-top:16px;">
      <div class="flex" style="gap:8px; align-items:center;">
        <button class="btn ghost" id="likeBtn" type="button" th:attr="data-id=${review.id}">좋아요</button>
        <span>♡ <b id="likeCount" th:text="${likeCount}">0</b></span>
      </div>

      <!-- 작성자만 수정/삭제 -->
      <div sec:authorize="isAuthenticated() and principal?.username == #vars.review.author.username">
        <a class="btn ghost" th:href="@{|/reviews/${review.id}/edit|}">수정</a>
        <form th:action="@{|/reviews/${review.id}/delete|}" method="post" style="display:inline" onsubmit="return confirm('정말 삭제할까요?')">
          <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
          <button class="btn danger" type="submit">삭제</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  const CSRF_TOKEN = document.querySelector('meta[name="_csrf"]')?.content;
  const CSRF_HEADER = document.querySelector('meta[name="_csrf_header"]')?.content;

  document.getElementById('likeBtn')?.addEventListener('click', async (e) => {
    const id = e.currentTarget.getAttribute('data-id');
    try {
      const res = await fetch(`/reviews/${id}/like-toggle`, {
        method: 'POST',
        headers: {
          'Accept': 'application/json',
          ...(CSRF_HEADER ? {[CSRF_HEADER]: CSRF_TOKEN} : {})
        }
      });
      if (!res.ok) {
        const text = await res.text();
        alert((text && text.substring(0,120)) || '요청 처리 중 오류가 발생했습니다.');
        return;
      }
      const data = await res.json();
      const el = document.getElementById('likeCount');
      if (el) el.textContent = data.likedCount ?? '0';
    } catch (e2) {
      console.error(e2);
      alert('네트워크 오류로 좋아요를 처리하지 못했습니다.');
    }
  });
</script>
</body>
</html>
