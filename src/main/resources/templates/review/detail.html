<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8"/>
  <title th:text="${(review != null and review.cafe != null) ? review.cafe.name + ' - 리뷰 상세' : '리뷰 상세'}">리뷰 상세</title>

  <!-- CSRF (POST 폼용) -->
  <meta th:if="${_csrf}" name="_csrf" th:content="${_csrf.token}"/>
  <meta th:if="${_csrf}" name="_csrf_header" th:content="${_csrf.headerName}"/>

  <link rel="stylesheet" th:href="@{/css/review-detail.css}"/>
</head>
<body>

<div class="rd-wrap" th:if="${review != null}">
  <header class="rd-header">
    <div class="rd-head-left">
      <h1 class="rd-title" th:text="${review.cafe != null ? review.cafe.name : '카페'}">카페명</h1>
      <div class="rd-pillset">
        <span class="rd-pill" th:text="'★ ' + ${#numbers.formatDecimal(review.rating,1,1)}">★ 0.0</span>
        <span class="rd-pill" th:text="'좋아요 ' + ${review.likeCount}">좋아요 0</span>
        <span class="rd-pill" th:text="'조회 ' + ${review.viewCount}">조회 0</span>
        <span class="rd-pill" th:text="${#temporals.format(review.createdAt, 'yyyy-MM-dd HH:mm')}">작성일</span>
      </div>
      <div class="rd-meta">
        작성자:
        <span th:text="${review.author != null ? review.author.username : '알수없음'}">작성자</span>
      </div>
    </div>

    <div class="rd-head-right">
      <a class="rd-link" th:if="${review.cafe != null}"
         th:href="@{|/cafes/${review.cafe.id}/reviews|}">← 리뷰 목록</a>

      <form class="rd-inline" sec:authorize="isAuthenticated()" th:action="@{|/reviews/${review.id}/like|}" method="post">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="rd-btn" type="submit">👍 좋아요</button>
      </form>
      <form class="rd-inline" sec:authorize="isAuthenticated()" th:action="@{|/reviews/${review.id}/unlike|}" method="post">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="rd-btn" type="submit">↩ 취소</button>
      </form>

      <!-- 수정/삭제: 작성자 or ADMIN -->
      <a class="rd-link"
         sec:authorize="isAuthenticated()"
         th:if="${review.author != null and #authentication?.name == review.author.username} or ${#authorization.expression('hasRole(''ADMIN'')')}"
         th:href="@{|/reviews/${review.id}/edit|}">✏️ 수정</a>

      <form class="rd-inline" sec:authorize="isAuthenticated()"
            th:if="${review.author != null and #authentication?.name == review.author.username} or ${#authorization.expression('hasRole(''ADMIN'')')}"
            th:action="@{|/reviews/${review.id}/delete|}" method="post"
            onsubmit="return confirm('정말 삭제하시겠습니까?');">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button class="rd-btn rd-btn-danger" type="submit">🗑 삭제</button>
      </form>
    </div>
  </header>

  <!-- 이미지 갤러리 -->
  <section class="rd-gallery" th:if="${review.images != null and !#lists.isEmpty(review.images)}">
    <img class="rd-thumb" th:each="img : ${review.images}" th:src="${img.imageUrl}" alt="리뷰 이미지"/>
  </section>

  <!-- 본문 -->
  <article class="rd-card">
    <div class="rd-content" th:text="${review.content}">리뷰 본문</div>
  </article>
</div>

<!-- 빈 상태(안정장치) -->
<div class="rd-wrap" th:if="${review == null}">
  <div class="rd-card">
    <p class="rd-muted">리뷰를 찾을 수 없습니다.</p>
    <a class="rd-link" th:href="@{/cafe/list}">← 카페 목록</a>
  </div>
</div>

<script th:src="@{/js/review-detail.js}" defer></script>
</body>
</html>

