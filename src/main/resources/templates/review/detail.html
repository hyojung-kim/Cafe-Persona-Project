<!DOCTYPE html>
<html lang="ko"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">

<th:block layout:fragment="headExtra">
  <meta charset="UTF-8"/>
  <title th:text="${review != null && review.cafe != null ? '리뷰 상세 - ' + review.cafe.name : '리뷰 상세'}">리뷰 상세</title>
  <link rel="stylesheet" th:href="@{/css/review-detail.css}"/>
</th:block>

<div layout:fragment="content" class="container mt-4">

  <section class="card shadow-sm mb-3">
    <div class="card-body d-flex justify-content-between align-items-start">
      <div>
        <h2 class="h4 mb-1">리뷰 상세</h2>
        <div class="text-muted small">
          작성자:
          <span class="badge bg-info text-dark"
                th:text="${review.user != null ? review.user.nickname : '알 수 없음'}">작성자</span>
          <span class="ms-2">
            작성일: <time th:text="${#temporals.format(review.createdAt,'yyyy-MM-dd HH:mm')}">-</time>
          </span>
        </div>
      </div>
      <div class="text-end">
        <div>
          <span class="rate read-only" th:with="r=${review.rating}">
            <input type="radio" id="detail-rating10" value="5.0" th:checked="${r == 5.0}">
            <label for="detail-rating10" title="5점"></label>
            <input type="radio" id="detail-rating9" value="4.5" th:checked="${r == 4.5}">
            <label class="half" for="detail-rating9" title="4.5점"></label>
            <input type="radio" id="detail-rating8" value="4.0" th:checked="${r == 4.0}">
            <label for="detail-rating8" title="4점"></label>
            <input type="radio" id="detail-rating7" value="3.5" th:checked="${r == 3.5}">
            <label class="half" for="detail-rating7" title="3.5점"></label>
            <input type="radio" id="detail-rating6" value="3.0" th:checked="${r == 3.0}">
            <label for="detail-rating6" title="3점"></label>
            <input type="radio" id="detail-rating5" value="2.5" th:checked="${r == 2.5}">
            <label class="half" for="detail-rating5" title="2.5점"></label>
            <input type="radio" id="detail-rating4" value="2.0" th:checked="${r == 2.0}">
            <label for="detail-rating4" title="2점"></label>
            <input type="radio" id="detail-rating3" value="1.5" th:checked="${r == 1.5}">
            <label class="half" for="detail-rating3" title="1.5점"></label>
            <input type="radio" id="detail-rating2" value="1.0" th:checked="${r == 1.0}">
            <label for="detail-rating2" title="1점"></label>
            <input type="radio" id="detail-rating1" value="0.5" th:checked="${r == 0.5}">
            <label class="half" for="detail-rating1" title="0.5점"></label>
          </span>
          <span class="ms-1" th:text="${#numbers.formatDecimal(review.rating,1,1)}">0.0</span> / 5.0
        </div>
        <div class="text-muted small mt-1">
          조회수: <span th:text="${review.viewCount}">0</span>
        </div>
        <div class="mt-2 review-like-box" th:data-review-id="${review.id}"
             th:data-liked="${liked}">
          <button type="button" class="btn btn-sm btn-outline-danger review-like-btn">
            <span class="label-liked" th:if="${liked}">♥ 좋아요 취소</span>
            <span class="label-unliked" th:if="${!liked}">♡ 좋아요</span>
          </button>
          <span class="review-like-count ms-1" th:text="${likeCount}">0</span>
        </div>
      </div>
    </div>
  </section>

  <section class="card shadow-sm mb-3">
    <div class="card-body">
      <p class="mb-0" th:text="${review.content}">-</p>
    </div>
  </section>

  <section class="card shadow-sm mb-3"
           th:if="${review.images != null and !#lists.isEmpty(review.images)}">
    <div class="card-body">
      <h3 class="h6 mb-3">첨부 이미지</h3>
      <div class="row row-cols-2 row-cols-md-3 g-2">
        <div class="col" th:each="img : ${review.images}">
          <img th:src="${img.imageUrl}" alt="review image" class="img-fluid rounded"/>
        </div>
      </div>
    </div>
  </section>

  <section class="card shadow-sm">
    <div class="card-body text-end">
      <a class="btn btn-sm btn-primary" th:href="@{|/cafes/${review.cafe.id}/reviews|}">목록</a>
      <a th:if="${canEdit}" class="btn btn-sm btn-secondary ms-1" th:href="@{|/reviews/${review.id}/edit|}">수정</a>
      <form th:if="${canEdit}" th:action="@{|/reviews/${review.id}/delete|}" method="post" class="d-inline ms-1" onsubmit="return confirm('정말 삭제하시겠습니까?');">
        <input type="hidden" th:if="${_csrf}" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
        <button type="submit" class="btn btn-sm btn-danger">삭제</button>
      </form>
    </div>
  </section>

  <!-- ★ 방어 스크립트: 빈/잘못된 script/link를 실시간 제거하고 원인 로그 출력 -->

  <!-- ✅ 레이아웃 삽입 슬롯 없어도 직접 로드 -->
  <script th:src="@{/js/review-like.js}" defer></script>
</div>

</html>
